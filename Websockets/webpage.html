<!DOCTYPE html>
<html>
<head>
<title>ESP SERVER</title>
<script src="https://code.highcharts.com/highcharts.js"></script>
</head>
<body style='background-color: #EEEEEE;'>

<span style='color: #003366;'>

<h1>ESP32 WEBSERVER FOR MPU6050</h1>
<p>Angulo normalizado eje y: <span id = 'rand1'>-</span></p>
<p>Angulo normalizado eje x: <span id = 'rand2'>-</span></p>
<p>Angulo normalizado eje z: <span id = 'rand3'>-</span></p>
<h2>Gyro</h2>
<p>Gyro x (rad/s): <span id = 'rand2'>-</span></p>
<p>Gyro y (rad/s): <span id = 'rand2'>-</span></p>
<p>Gyro z (rad/s): <span id = 'rand2'>-</span></p>
<h1>Valores PID</h1>

<form>
  <label for="kp">Kp:</label>
  <input type="number" id="kp" name="quantity" step="0.00001">
  <label for="kd">Kd:</label>
  <input type="number" id="kd" name="quantity" step="0.00001">
  <label for="ki">Ki:</label>
  <input type="number" id="ki" name="quantity" step="0.00001">
</form>

<p><button type='button' id='BTN_SEND_BACK'>
Send info to ESP32
</button></p>
</span>
<!-- AJAX CODE TO SEND INFORMATION TO ESP32 -->
<script>
//INCOMING DATA ARRAY
/*	This array has to go to local webpage storage to be used later in the graph
 *	Then it needs to be downloadable
 */
let incoming_data = [];
//WEBSOCKET CODE
var Socket;
document.getElementById('BTN_SEND_BACK').addEventListener('click', button_send_back);
function init() {
	Socket = new WebSocket('ws://' + window.location.hostname + ':81/');
	Socket.onmessage = function(event) {
		processCommand(event);
	};
}
function button_send_back(ev){
	ev.preventDefault(); //To prevent the form from reloading and reseting the input boxes
	var guitar = {
	brand: 'Gibson',
	type: 'Les Paul Studio',
	year: 2010,
	color: 'white'
	};
	let PID = {
		kp: document.getElementById('kp').value,
		kd: document.getElementById('kd').value,
		ki: document.getElementById('ki').value
	};
	Socket.send(JSON.stringify(PID));
	console.log(PID);
}
function processCommand(event){
	var obj = JSON.parse(event.data);	
	document.getElementById('rand1').innerHTML = obj.rand1;
	document.getElementById('rand2').innerHTML = obj.rand2;
	//Put the incoming sensor values to an array for easier graphing
	incoming_data.push(obj.rand1);
	incoming_data.push(obj.rand2);
	//console.log(incoming_data);
	//console.log(obj.rand1);
	//console.log(obj.rand2);
	
	//SAVING TO localStorage
	//THE JSON OBJECT NEEDS TO BE A STRING
	//REMEMBER TO PARSE IT WHEN YOU GET IT 
	//let variable = localStorage.getItem("name_of_data");
	//let object = JSON.parse(variable);
	//NOW YOU CAN USE THE DATA INSIDE OF THE OBJECT IN YOUR CODE
	localStorage.setItem("Data_esp", JSON.stringify(incoming_data));
}
window.onload = function(event) {
	init();
}
</script>

<!-- // IMU GRAPH -->
<div id="container" style="width:50%; height:300px;"></div>
<script>
let chart; //global chart
let memory; //global memory
let data; //global memory
//ASK FOR DATA FROM localStorage EVERY SECOND
setInterval(function requestData() {
	memory = localStorage.getItem("Data_esp");
	data = JSON.parse(memory);
	let data_size = data.length - 1; //Size of the array
	const point = data[data_size]; //Obtain the latest point in the graph
	const series = chart.series[0],
		shift = series.data.length > 20; //Start shifting data if there is more than 20 entrys
		//THE NUMBER 20 IS THE NUMBER OF DATA SHOWN IN THE GRAPH
		
	//add the point to the graph
	chart.series[0].addPoint(point, true, shift);
	
	console.log(data);
}, 500);


document.addEventListener('DOMContentLoaded', function () {
        chart = Highcharts.chart('container', {
            chart: {
                type: 'line',
				zoomType: 'x'
            },
			credits: {
				enabled: false
			}
			,
            title: {
                text: 'Angulo del balancin'
            },
            xAxis: {
                //categories: []
            },
            yAxis: {
                title: {
                    text: 'Angulo (rad)'
                }
            },
            series: [{
                name: 'Angulo (rad)',
                data: [] //incoming_data
            }]
			
        });
    });

</script>

</body>
</html>
